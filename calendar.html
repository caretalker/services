<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>会話履歴</title>
  <link rel="stylesheet" href="common.css">
  <style>
    .calendar-container {
      padding: 20px;
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      overflow-y: auto;
    }

    .calendar-body-wrapper {
      width: 100%;
      max-width: 400px;
    }

    .search {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .search input[type="text"] {
      flex: 1;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .search-button {
      background-color: #ccc;
      color: #333;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      padding: 8px 12px;
      transition: background-color 0.2s ease;
    }

    .search-button:hover {
      background-color: #ddd;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      font-weight: bold;
      align-items: center;
    }

    .calendar-header span {
      margin: 0 10px;
    }

    .arrow-button {
      background-color: #f5f5f5;
      color: #000000;
      border: none;
      cursor: pointer;
      padding: 6px 12px;
      font-size: 16px;
      transition: background-color 0.2s ease;
      border-radius: 4px;
    }

    .arrow-button:hover {
      background-color: #f5f5f5;
      color: #999;
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      text-align: center;
    }

    .calendar-day {
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .calendar-day:hover {
      background-color: #e0e0e0;
    }

    .calendar-day.unavailable {
      color: #ccc;
      cursor: not-allowed;
      background-color: #f8f8f8;
    }

    .calendar-day.unavailable:hover {
      background-color: #f8f8f8;
    }

    .calendar-day.selected {
      background-color: #007bff;
      color: #fff;
      border-radius: 6px;
    }

    .calendar-day.available {
      background-color: #e8f4fd;
      color: #007bff;
      font-weight: bold;
    }

    .ok-button {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .ok-button button {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      padding: 8px 16px;
      transition: background-color 0.2s ease;
      display: none;
    }

    .ok-button button:hover {
      background-color: #0056b3;
    }

    .ok-button button.visible {
      display: block;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
      font-size: 14px;
    }

    .error {
      text-align: center;
      padding: 20px;
      color: #e74c3c;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="date">2025 3/3</div>
    <div class="header-icons">
      <img src="notifications.png" alt="通知" />
      <img src="Settings.png" alt="設定" />
      <img src="account_circle.png" alt="プロフィール" />
    </div>
  </div>

  <div class="calendar-container">
    <div class="calendar-body-wrapper">
      <div class="search">
        <input type="text" placeholder="会話履歴を検索..." />
        <button class="search-button">検索</button>
      </div>

      <div id="loadingMessage" class="loading">会話履歴の可用性を確認中...</div>
      <div id="errorMessage" class="error" style="display: none;"></div>

      <div id="calendarSection" style="display: none;">
        <div class="calendar-header">
          <button class="arrow-button" id="prevMonth">&lt;</button>
          <span id="monthDisplay">8月</span>
          <button class="arrow-button" id="nextMonth">&gt;</button>
          <button class="arrow-button" id="prevYear">&lt;</button>
          <span id="yearDisplay">2025</span>
          <button class="arrow-button" id="nextYear">&gt;</button>
        </div>
        
        <div class="calendar">
          <div>日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div>土</div>
          <!-- 日付が動的に挿入される -->
        </div>

        <div class="ok-button">
          <button id="okButton" onclick="showConversation()">会話を見る</button>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <img src="Home.png" alt="ホーム" />
    <img src="List.png" alt="記録" />
    <img src="File text.png" alt="カルテ" />
    <img src="Settings.png" alt="設定" />
  </div>

  <script src="navigation.js"></script>
  <script>
    const CLOUD_RUN_URL = 'https://loginservice-family-sucmscarza-an.a.run.app';
    let currentClientId = null;
    let currentDate = new Date();
    let selectedDay = null;
    let availableDays = [];

    // ページ読み込み時の初期化
    document.addEventListener('DOMContentLoaded', function() {
      // ログイン状態をチェック
      currentClientId = sessionStorage.getItem('userSerial');
      
      if (!currentClientId) {
        showError('ログインが必要です。ログインページに戻ります。');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);
        return;
      }

      // イベントリスナーを設定
      setupEventListeners();
      
      // 初期表示
      updateCalendarDisplay();
      loadAvailability();
    });

    function setupEventListeners() {
      document.getElementById('prevMonth').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        updateCalendarDisplay();
        loadAvailability();
        resetSelection();
      });

      document.getElementById('nextMonth').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        updateCalendarDisplay();
        loadAvailability();
        resetSelection();
      });

      document.getElementById('prevYear').addEventListener('click', () => {
        currentDate.setFullYear(currentDate.getFullYear() - 1);
        updateCalendarDisplay();
        loadAvailability();
        resetSelection();
      });

      document.getElementById('nextYear').addEventListener('click', () => {
        currentDate.setFullYear(currentDate.getFullYear() + 1);
        updateCalendarDisplay();
        loadAvailability();
        resetSelection();
      });
    }

    function updateCalendarDisplay() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      document.getElementById('monthDisplay').textContent = `${month + 1}月`;
      document.getElementById('yearDisplay').textContent = year;

      generateCalendar(year, month);
    }

    function generateCalendar(year, month) {
      const calendar = document.querySelector('.calendar');
      
      // 既存の日付セルを削除（曜日ヘッダーは残す）
      const dayCells = calendar.querySelectorAll('.calendar-day');
      dayCells.forEach(cell => cell.remove());

      // 月の最初の日と最後の日を取得
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const firstDayOfWeek = firstDay.getDay(); // 0=日曜日
      const daysInMonth = lastDay.getDate();

      // 空のセルを追加（月の最初の日まで）
      for (let i = 0; i < firstDayOfWeek; i++) {
        const emptyCell = document.createElement('div');
        calendar.appendChild(emptyCell);
      }

      // 日付セルを追加
      for (let day = 1; day <= daysInMonth; day++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'calendar-day';
        dayCell.textContent = day;
        dayCell.addEventListener('click', () => selectDay(day));
        calendar.appendChild(dayCell);
      }
    }

    function selectDay(day) {
      // 利用可能でない日は選択できない
      if (!availableDays.includes(day)) {
        return;
      }

      // 以前の選択を解除
      const previousSelected = document.querySelector('.calendar-day.selected');
      if (previousSelected) {
        previousSelected.classList.remove('selected');
      }

      // 新しい選択を設定
      const dayCell = Array.from(document.querySelectorAll('.calendar-day'))
        .find(cell => cell.textContent == day);
      
      if (dayCell) {
        dayCell.classList.add('selected');
        selectedDay = day;
        showOkButton();
      }
    }

    function resetSelection() {
      selectedDay = null;
      hideOkButton();
      
      const selected = document.querySelector('.calendar-day.selected');
      if (selected) {
        selected.classList.remove('selected');
      }
    }

    function showOkButton() {
      document.getElementById('okButton').classList.add('visible');
    }

    function hideOkButton() {
      document.getElementById('okButton').classList.remove('visible');
    }

    async function loadAvailability() {
      try {
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        const yearMonth = `${year}-${month}`;

        const response = await fetch(`${CLOUD_RUN_URL}/conversation-availability/${currentClientId}/${yearMonth}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();

        if (response.ok && data.success) {
          availableDays = data.available_days || [];
          updateCalendarAvailability();
          showCalendar();
        } else {
          availableDays = [];
          updateCalendarAvailability();
          showCalendar();
        }
      } catch (error) {
        console.error('Error loading availability:', error);
        showError('可用性の確認中にエラーが発生しました。');
      } finally {
        hideLoading();
      }
    }

    function updateCalendarAvailability() {
      const dayCells = document.querySelectorAll('.calendar-day');
      
      dayCells.forEach(cell => {
        const day = parseInt(cell.textContent);
        
        if (availableDays.includes(day)) {
          cell.classList.add('available');
          cell.classList.remove('unavailable');
        } else {
          cell.classList.add('unavailable');
          cell.classList.remove('available');
        }
      });
    }

    function showConversation() {
      if (!selectedDay) return;

      const year = currentDate.getFullYear();
      const month = String(currentDate.getMonth() + 1).padStart(2, '0');
      const day = String(selectedDay).padStart(2, '0');
      const dateString = `${year}-${month}-${day}`;

      // 会話表示ページに遷移（パラメータ付き）
      sessionStorage.setItem('selectedConversationDate', dateString);
      window.location.href = 'conversation_view.html';
    }

    function showLoading() {
      document.getElementById('loadingMessage').style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loadingMessage').style.display = 'none';
    }

    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorMessage').style.display = 'block';
    }

    function showCalendar() {
      document.getElementById('calendarSection').style.display = 'block';
    }
  </script>
</body>
</html>
