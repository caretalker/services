<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>レポート画面</title>
  <link rel="stylesheet" href="common.css">

  <style>
    .content-container {
      padding: 20px;
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      overflow-y: auto;
    }

    .content {
      width: 100%;
      max-width: 400px;
      background: #fff;
    }

    .month-selector {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-top: 16px;
      margin-bottom: 12px;
    }

    .month-button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }

    .month-button:hover {
      background-color: #f0f0f0;
    }

    .month-button:disabled {
      color: #ccc;
      cursor: not-allowed;
    }

    .current-month {
      font-size: 18px;
      color: #000;
      font-weight: bold;
      min-width: 120px;
      text-align: center;
    }

    .pdf-button-wrapper {
      display: flex;
      justify-content: flex-end;
      margin-top: 16px;
    }

    .pdf-button {
      background-color: #000;
      color: #fff;
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }

    .pdf-button:hover {
      background-color: #333;
    }

    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #666;
      font-size: 16px;
    }

    .error {
      text-align: center;
      padding: 40px 20px;
      color: #e74c3c;
      font-size: 16px;
    }

    .no-report {
      text-align: center;
      padding: 40px 20px;
      color: #888;
      font-size: 16px;
    }

    .report-content {
      padding: 16px 0;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
      border: 1px solid #eee;
      border-radius: 8px;
      background-color: #fafafa;
      padding: 16px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="date">2025 3/3</div>
    <div class="header-icons">
      <img src="notifications.png" alt="通知" />
      <img src="Settings.png" alt="設定" />
      <img src="account_circle.png" alt="プロフィール" />
    </div>
  </div>

  <div class="month-selector">
    <button class="month-button" id="prevMonth">＜</button>
    <span class="current-month" id="currentMonth">2025年8月</span>
    <button class="month-button" id="nextMonth">＞</button>
  </div>

  <div class="content-container">
    <div class="content">
      <div id="loadingMessage" class="loading">レポートを読み込み中...</div>
      <div id="errorMessage" class="error" style="display: none;"></div>
      <div id="noReportMessage" class="no-report" style="display: none;">レポートが見つかりません</div>
      
      <div id="reportContent" style="display: none;">
        <div class="report-content" id="reportText"></div>
        <div class="pdf-button-wrapper">
          <a href="#" class="pdf-button" onclick="downloadReport()">PDF出力</a>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <img src="Home.png" alt="ホーム" />
    <img src="List.png" alt="記録" />
    <img src="File text.png" alt="カルテ" />
    <img src="Settings.png" alt="設定" />
  </div>

  <script src="navigation.js"></script>
  <script>
    const CLOUD_RUN_URL = 'https://loginservice-family-sucmscarza-an.a.run.app';

    // 現在の月を管理する変数
    let currentDate = new Date();
    let currentClientId = null;

    // ページ読み込み時の初期化
    document.addEventListener('DOMContentLoaded', function() {
      // ログイン状態をチェック
      currentClientId = sessionStorage.getItem('userSerial');
      
      if (!currentClientId) {
        showError('ログインが必要です。ログインページに戻ります。');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);
        return;
      }

      // 月表示を更新
      updateMonthDisplay();
      
      // レポートを読み込み
      loadReport();

      // ボタンイベントリスナーを設定
      document.getElementById('prevMonth').addEventListener('click', previousMonth);
      document.getElementById('nextMonth').addEventListener('click', nextMonth);
    });

    function updateMonthDisplay() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth() + 1;
      document.getElementById('currentMonth').textContent = `${year}年${month}月`;
      
      // 未来の月への移動を制限
      const now = new Date();
      const isCurrentOrFutureMonth = (year > now.getFullYear()) || 
                                   (year === now.getFullYear() && month > now.getMonth() + 1);
      document.getElementById('nextMonth').disabled = isCurrentOrFutureMonth;
    }

    function previousMonth() {
      currentDate.setMonth(currentDate.getMonth() - 1);
      updateMonthDisplay();
      loadReport();
    }

    function nextMonth() {
      const now = new Date();
      const nextMonth = new Date(currentDate);
      nextMonth.setMonth(nextMonth.getMonth() + 1);
      
      // 未来の月には移動しない
      if (nextMonth.getFullYear() < now.getFullYear() || 
          (nextMonth.getFullYear() === now.getFullYear() && nextMonth.getMonth() <= now.getMonth())) {
        currentDate = nextMonth;
        updateMonthDisplay();
        loadReport();
      }
    }

    async function loadReport() {
      showLoading();
      hideError();
      hideNoReport();
      hideReportContent();

      try {
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        const yearMonth = `${year}-${month}`;

        console.log(`Trying to load report for: ${currentClientId}, ${yearMonth}`);

        // Flask APIからレポートを取得
        const response = await fetch(`${CLOUD_RUN_URL}/report/${currentClientId}/${yearMonth}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();

        if (response.ok && data.success) {
          // レポートを表示
          document.getElementById('reportText').textContent = data.content;
          showReportContent();
        } else if (data.not_found) {
          // ファイルが見つからない場合
          showNoReport();
        } else {
          // その他のエラー
          showError(data.message || 'レポートの読み込み中にエラーが発生しました。');
        }
        
      } catch (error) {
        console.error('Error loading report:', error);
        showError('ネットワークエラーが発生しました。インターネット接続を確認してください。');
      } finally {
        hideLoading();
      }
    }

    function showLoading() {
      document.getElementById('loadingMessage').style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loadingMessage').style.display = 'none';
    }

    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorMessage').style.display = 'block';
    }

    function hideError() {
      document.getElementById('errorMessage').style.display = 'none';
    }

    function showNoReport() {
      document.getElementById('noReportMessage').style.display = 'block';
    }

    function hideNoReport() {
      document.getElementById('noReportMessage').style.display = 'none';
    }

    function showReportContent() {
      document.getElementById('reportContent').style.display = 'block';
    }

    function hideReportContent() {
      document.getElementById('reportContent').style.display = 'none';
    }

    function downloadReport() {
      const reportText = document.getElementById('reportText').textContent;
      if (!reportText) {
        alert('ダウンロードするレポートがありません。');
        return;
      }

      const year = currentDate.getFullYear();
      const month = String(currentDate.getMonth() + 1).padStart(2, '0');
      const filename = `report_${year}-${month}.txt`;

      // テキストファイルとしてダウンロード
      const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
